!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("core-js/modules/es6.array.for-each.js"),require("core-js/modules/es6.array.find-index.js"),require("core-js/modules/es6.array.filter.js"),require("core-js/modules/es6.object.to-string.js"),require("core-js/modules/es6.array.iterator.js"),require("core-js/modules/web.dom.iterable.js"),require("core-js/modules/es6.object.keys.js"),require("core-js/modules/es6.array.index-of.js"),require("core-js/modules/es6.array.map.js"),require("core-js/modules/es7.array.flat-map.js"),require("core-js/modules/es6.array.sort.js"),require("core-js/modules/es6.symbol.js"),require("core-js/modules/es6.array.from.js"),require("core-js/modules/es6.string.iterator.js"),require("core-js/modules/es6.set.js"),require("core-js/modules/es6.promise.js"),require("core-js/modules/es6.array.slice.js"),require("core-js/modules/es6.array.find.js"),require("core-js/modules/es6.map.js"),require("core-js/modules/es6.function.name.js"),require("core-js/modules/es6.array.is-array.js"),require("core-js/modules/es6.array.fill.js"),require("core-js/modules/es6.regexp.split.js"),require("core-js/modules/es6.array.some.js")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es6.array.for-each.js","core-js/modules/es6.array.find-index.js","core-js/modules/es6.array.filter.js","core-js/modules/es6.object.to-string.js","core-js/modules/es6.array.iterator.js","core-js/modules/web.dom.iterable.js","core-js/modules/es6.object.keys.js","core-js/modules/es6.array.index-of.js","core-js/modules/es6.array.map.js","core-js/modules/es7.array.flat-map.js","core-js/modules/es6.array.sort.js","core-js/modules/es6.symbol.js","core-js/modules/es6.array.from.js","core-js/modules/es6.string.iterator.js","core-js/modules/es6.set.js","core-js/modules/es6.promise.js","core-js/modules/es6.array.slice.js","core-js/modules/es6.array.find.js","core-js/modules/es6.map.js","core-js/modules/es6.function.name.js","core-js/modules/es6.array.is-array.js","core-js/modules/es6.array.fill.js","core-js/modules/es6.regexp.split.js","core-js/modules/es6.array.some.js"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).datamations={})}(this,(function(e){"use strict";var t=function(e){var t,r=Object.prototype,n=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var a=t&&t.prototype instanceof g?t:g,o=Object.create(a.prototype),i=new k(n||[]);return o._invoke=function(e,t,r){var n=d;return function(a,o){if(n===m)throw new Error("Generator is already running");if(n===p){if("throw"===a)throw o;return S()}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var c=j(i,r);if(c){if(c===h)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===d)throw n=p,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=m;var s=l(e,t,r);if("normal"===s.type){if(n=r.done?p:f,s.arg===h)continue;return{value:s.arg,done:r.done}}"throw"===s.type&&(n=p,r.method="throw",r.arg=s.arg)}}}(e,r,i),o}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var d="suspendedStart",f="suspendedYield",m="executing",p="completed",h={};function g(){}function y(){}function v(){}var x={};s(x,o,(function(){return this}));var _=Object.getPrototypeOf,w=_&&_(_(D([])));w&&w!==r&&n.call(w,o)&&(x=w);var b=v.prototype=g.prototype=Object.create(x);function E(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function F(e,t){function r(a,o,i,c){var s=l(e[a],e,o);if("throw"!==s.type){var u=s.arg,d=u.value;return d&&"object"==typeof d&&n.call(d,"__await")?t.resolve(d.__await).then((function(e){r("next",e,i,c)}),(function(e){r("throw",e,i,c)})):t.resolve(d).then((function(e){u.value=e,i(u)}),(function(e){return r("throw",e,i,c)}))}c(s.arg)}var a;this._invoke=function(e,n){function o(){return new t((function(t,a){r(e,n,t,a)}))}return a=a?a.then(o,o):o()}}function j(e,r){var n=e.iterator[r.method];if(n===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,j(e,r),"throw"===r.method))return h;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return h}var a=l(n,e.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,h;var o=a.arg;return o?o.done?(r[e.resultName]=o.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,h):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,h)}function L(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(L,this),this.reset(!0)}function D(e){if(e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,i=function r(){for(;++a<e.length;)if(n.call(e,a))return r.value=e[a],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}return{next:S}}function S(){return{value:t,done:!0}}return y.prototype=v,s(b,"constructor",v),s(v,"constructor",y),y.displayName=s(v,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,s(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},E(F.prototype),s(F.prototype,i,(function(){return this})),e.AsyncIterator=F,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new F(u(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},E(b),s(b,c,"Generator"),s(b,o,(function(){return this})),s(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=D,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(I),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function a(n,a){return c.type="throw",c.arg=e,r.next=n,a&&(r.method="next",r.arg=t),!!a}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var s=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(s&&u){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,h):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),I(r),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;I(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:D(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),h}},e}("object"==typeof module?module.exports:{});try{regeneratorRuntime=t}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}var r={X_FIELD:"datamations_x",Y_FIELD:"datamations_y",ORDER_FIELD:"datamations_order",SCHEME:"https://vega.github.io/schema/vega-lite/v4.json"},n=["tooltip","x","y","datamations_x","datamations_y"],a={grid:"grid",jitter:"jitter"};function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){l(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function s(e,t,r,n,a,o,i){try{var c=e[o](i),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,a)}function u(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){s(o,n,a,i,c,"next",e)}function c(e){s(o,n,a,i,c,"throw",e)}i(void 0)}))}}function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function d(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==r)return;var n,a,o=[],i=!0,c=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){c=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(c)throw a}}return o}(e,t)||m(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(e){return function(e){if(Array.isArray(e))return p(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||m(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(e,t){if(e){if("string"==typeof e)return p(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?p(e,t):void 0}}function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function h(e){var t="#"+e;return{axisSelector:t+" .vega-for-axis",visSelector:t+" .vega-vis",descr:t+" .description",slider:t+" .slider",otherLayers:t+" .vega-other-layers",controls:t+" .controls-wrapper",exportWrap:t+" .export-wrapper",exportBtn:t+" .export-btn",replayBtn:t+" .replay-btn"}}function g(e){var t=[],r=e.spec;return r&&r.layer?r.layer.forEach((function(n,a){var o=JSON.parse(JSON.stringify(e)),i=a===r.layer.length-1;o.meta?o.meta.animated=i:o.meta={animated:i},o.spec.encoding=n.encoding,o.spec.mark=n.mark,delete o.spec.layer,t.push(o)})):e.layer&&e.layer.forEach((function(r,n){var a=JSON.parse(JSON.stringify(e)),o=n===e.layer.length-1;a.meta?a.meta.animated=o:a.meta={animated:o},a.encoding=r.encoding,a.mark=r.mark,delete a.layer,t.push(a)})),t}function y(e,t,r){return e[t.findIndex((function(e){return r<=e}))]}function v(e){var t=0;return e.filter((function(e){return"grid"===e.meta.parse})).forEach((function(e){var r=e.spec||e,a=r.width,o=r.height,i=e.spec?e.spec.encoding:e.encoding,c=e.meta.splitField,s=[];e.facet&&(e.facet.column&&s.push(e.facet.column.field),e.facet.row&&s.push(e.facet.row.field));var u=e.data.values,d=Object.keys(i).filter((function(e){var t=i[e].field;return t!==c&&-1===n.indexOf(e)&&-1===s.indexOf(t)}))[0];if(c&&d){var m,p=i[d].field,h=[].concat(s,[c]),g=(m=d3).rollups.apply(m,[u,function(e){var t,r={},n=0;e.forEach((function(e){n+=e.n,r[e[p]]=n}));var a=(l(t={},c,e[0][c]),l(t,p,r),l(t,"n",n),t);return s.forEach((function(t){a[t]=e[0][t]})),a}].concat(f(h.map((function(e){return function(t){return t[e]}})))));u=g.flatMap((function(e){return 1===h.length?e[1]:e[1].flatMap((function(e){return e[1]}))})),a/=g.length}var y=d3.max(u,(function(e){return e.n})),v=Math.ceil(Math.sqrt(y));a/Math.ceil(y/v)<5&&(v=Math.floor(o/6)),v>t&&(t=v)})),t}function x(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=e.meta.splitField,s=e.spec?e.spec.encoding:e.encoding,u=[],d=e.spec||e;d.width;e.facet&&(e.facet.column&&(u.push(e.facet.column.field),e.facet.column.sort={field:r.ORDER_FIELD}),e.facet.row&&(u.push(e.facet.row.field),e.facet.row.sort={field:r.ORDER_FIELD}));var m=e.data.values,p=[];m.forEach((function(e,t){e[r.ORDER_FIELD]=t,e.meta&&p.push.apply(p,f(Object.keys(e.meta)))}));var h=Object.keys(s).filter((function(e){var t=s[e].field;return t!==o&&-1===n.indexOf(e)&&-1===u.indexOf(t)&&-1===p.indexOf(t)}))[0],g=null;if(o&&h){var v;g=s[h].field;var x=[].concat(u,[o]),_=(v=d3).rollups.apply(v,[m,function(e){var t,r={},n=0;e.forEach((function(e){n+=e.n,r[e[g]]=n}));var a=(l(t={},o,e[0][o]),l(t,g,r),l(t,"n",n),t);return u.forEach((function(t){a[t]=e[0][t]})),a}].concat(f(x.map((function(e){return function(t){return t[e]}})))));m=_.flatMap((function(e){return 1===x.length?e[1]:e[1].flatMap((function(e){return e[1]}))})),_.length}var w=Math.ceil(d3.max(m,(function(e){return e.n}))/t),b=[];o&&(b=Array.from(new Set(m.map((function(e){return e[o]})))));var E,F=1,j=function(e){var n=[];return e.forEach((function(e,s){var u=e.n,d=Math.ceil(u/t),f=o?b.indexOf(e[o])+1:1,m=(f-1)*w+s;m+=Math.floor((w-d)/2);var p={};Object.keys(e).forEach((function(t){"n"!==t&&"gemini_ids"!==t&&(p[t]=e[t])}));for(var h=0;h<u;h++){var v,x=m+Math.floor(h/t),_=t-1-h%t,E={};if(g&&"object"===c([e[g]])){var j=Object.keys(e[g]).sort((function(t,r){return e[g][t]-e[g][r]}));E[g]=y(j,j.map((function(t){return e[g][t]})),h+1)}n.push(i(i(i({},p),E),{},(l(v={gemini_id:e.gemini_ids?e.gemini_ids[h]:F},r.X_FIELD,a?f:x),l(v,r.Y_FIELD,a?h+1:_),v))),F++}})),n},L=[];0===u.length?L=j(m):L=(E=d3).rollups.apply(E,[m,j].concat(f(u.map((function(e){return function(t){return t[e]}}))))).flatMap((function(e){return 1===u.length?e[1]:e[1].flatMap((function(e){return e[1]}))}));var I=b.length;return{gridValues:L,domain:[-w/2,I*w+(I-1)+w/2-1],num_groups:I}}function _(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new Promise((function(a){var o=x(e,t,n),c=o.gridValues,s=o.domain,u=o.num_groups,l=i({},e),d=l.spec?l.spec.encoding:l.encoding,f=n||0===u?[d3.min(c,(function(e){return e[r.X_FIELD]}))-1,d3.max(c,(function(e){return e[r.X_FIELD]}))+1]:s,m=e.facet&&e.facet.row?.8:.4,p=[n?0:d3.min(c,(function(e){return e[r.Y_FIELD]}))-m,d3.max(c,(function(e){return e[r.Y_FIELD]}))+m+(n?10:0)],h=p[0]+(p[1]-p[0])/2;if(l.data.values=c,d.x.scale={type:"linear",domain:f},d.y.scale={type:"linear",domain:[Math.min(p[0],h-t/2),Math.max(p[1],h+t/2)]},d.x.field=r.X_FIELD,d.y.field=r.Y_FIELD,e.meta.splitField){var g=Array.from(new Set(c.map((function(t){return t[e.meta.splitField]})))),y={};g.forEach((function(t){var n=d3.extent(e.data.values.filter((function(r){return r[e.meta.splitField]===t})),(function(e){return e[r.X_FIELD]})),a=Math.ceil(n[0]+(n[1]-n[0])/2);y[a]=t})),e.meta.rules=l.meta.rules=g.map((function(t){return{filter:"datum['".concat(e.meta.splitField,"'] === '").concat(t,"'"),groupKey:e.meta.splitField,groupValue:t}})),d.x.axis={labelExpr:"".concat(JSON.stringify(y),"[datum.label]"),values:Object.keys(y).map((function(e){return+e})),labelAngle:-90,grid:!1,title:e.meta.splitField}}return a(l)}))}function w(e){var t=e.spec?e.spec.encoding:e.encoding,n=e.spec?e.spec.width:e.width,a=e.data.values,o=1;e.meta.splitField&&(o=new Set(a.map((function(t){return t[e.meta.splitField]}))).size);var c=n||150,s=d3.extent(a,(function(e){return e[r.Y_FIELD]})),u=d3.scaleBand().domain(d3.range(1,o+1)).range([0,c]).paddingOuter(.5),l=a.slice().filter((function(e){return void 0!==e[r.Y_FIELD]})).map((function(e,t){e.oldX=e[r.X_FIELD],e.oldY=e[r.Y_FIELD];var n=u(e[r.X_FIELD])+u.bandwidth()/2,a=e[r.Y_FIELD];return e.scaledX=Math.round(n),i(i({},e),{},{x:n,y:a})})),d=d3.forceSimulation(l).force("x",d3.forceX().x((function(e){return e.x}))).force("y",d3.forceY().strength(.002).y((function(e){return e[r.Y_FIELD]}))).force("collide",d3.forceCollide().strength(.01).radius(4)).stop();return new Promise((function(r){for(var n=.9*u.bandwidth(),a=0;a<120;a++)d.tick(),l.forEach((function(e){var t=u(e.oldX);e.y=e.oldY,e.x=Math.max(t+.05*u.bandwidth(),Math.min(t+n,e.x))}));if(t.y.scale?t.y.scale.domain=s:t.y.scale={domain:s},t.x.scale={domain:[0,c]},t.x.field="x",t.y.field="y",!e.meta.axes&&t.x.axis&&e.meta.xAxisLabels){var o=e.meta.xAxisLabels,f={},m=o.map((function(e,t){var r=Math.round(u(t+1)+u.bandwidth()/2);return f[r]=e,{x:r,label:e}}));t.x.axis.labelExpr="".concat(JSON.stringify(f),"[datum.label]"),t.x.axis.values=m.map((function(e){return e.x}))}return r(i(i({},e),{},{data:{name:"source",values:l}}))}))}var b,E=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=t.spec||t,o=a.width,c=a.height,s=e.data.values.slice(),u=e.meta,d=u.rules.map((function(e,t){var n=u.rules.length;return{transform:[{filter:e.filter}],name:"rule-".concat(t+1),mark:{type:"rule",x:{expr:"".concat(t+1," * (width / ").concat(n+1,") - 5")},x2:{expr:"".concat(t+1," * (width / ").concat(n+1,") + 5")}},encoding:{y:{field:r.Y_FIELD,type:"quantitative",aggregate:"count"}}}}));return n&&(s=s.map((function(e,n){var a=t.data.values[n][r.Y_FIELD];return i(i({},e),{},l({},r.Y_FIELD,a))}))),{$schema:r.SCHEME,width:o,height:c,data:{name:"source",values:s},layer:[{name:"main",mark:e.mark,encoding:e.encoding}].concat(f(d))}},F=function(e,t){var n,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.5,c=[],s=t.spec||t,u=s.width,d=s.height,m=null===a,p=e.meta.hasFacet,h=e.meta,g=[],y=function(e){var t=e[0][r.X_FIELD],n=e.slice().sort((function(e,t){return d3[p?"descending":"ascending"](e[r.Y_FIELD],t[r.Y_FIELD])})).map((function(e,t){return i(i({},e),{},{rank:t+1})})),s=d3.quantile(n,o,(function(e){return p?e.oldY:e[r.Y_FIELD]})),u=p?e[0].scaleY(s):s,d=d3.quantile(n,.5,(function(e){return e.rank})),y=d3.max(n,(function(e){return e.rank})),v=m?null:y-d-a,x=p?5:.1;n=n.map((function(e){var t,n=Math.abs(e.rank-d),a=(p?e.oldY:e[r.Y_FIELD])-s,o=null!==v&&n<=v?0:a>0?1:-1,c=null;return c=-1===o?e[r.X_FIELD]-x:1===o?e[r.X_FIELD]+x:e[r.X_FIELD],i(i({},e),{},(l(t={bisection:o},r.X_FIELD+"_pos",c),l(t,"y_median",s),l(t,"y_median_pos",u),t))}));var _="datum['".concat(r.X_FIELD,"'] === ").concat(t," && datum.bisection === 0"),w="datum['".concat(r.X_FIELD,"'] === ").concat(t),b=t;p&&(_+=" && ",w+=" && ",b+="_",h.columnFacet&&(_+="datum['".concat(h.columnFacet.field,"'] === '").concat(e[0][h.columnFacet.field],"'"),w+="datum['".concat(h.columnFacet.field,"'] === '").concat(e[0][h.columnFacet.field],"'"),b+=e[0][h.columnFacet.field]),h.columnFacet&&h.rowFacet&&(_+=" && ",w+=" && ",b+="_"),h.rowFacet&&(_+="datum['".concat(h.rowFacet.field,"'] === '").concat(e[0][h.rowFacet.field],"'"),w+="datum['".concat(h.rowFacet.field,"'] === '").concat(e[0][h.rowFacet.field],"'"),b+=e[0][h.rowFacet.field])),c.push({filter:_,groupFilter:w,groupValue:t,groupKey:r.X_FIELD,median:s,groupId:b,median_pos:u,rankDiff:Math.abs(y-d),rule_start:d3.min(n,(function(e){return e[r.X_FIELD+"_pos"]}))+1,rule_end:d3.max(n,(function(e){return e[r.X_FIELD+"_pos"]}))-1}),g.push.apply(g,f(n))},v=[r.X_FIELD];p&&(h.columnFacet&&v.push(h.columnFacet.field),h.rowFacet&&v.push(h.rowFacet.field)),(n=d3).rollup.apply(n,[e.data.values.slice(),y].concat(f(v.map((function(e){return function(t){return t[e]}})))));var x=[],_=m?"y_median":r.Y_FIELD;return p&&(_=m?"y_median_pos":r.Y_FIELD),c.forEach((function(e,t){var r=c.length,n={transform:m?[{filter:e.groupFilter}]:[{filter:e.filter}],name:"top_rule_".concat(e.groupId),mark:{type:"rule",x:p?e.rule_start:{expr:"".concat(t+1," * (width / ").concat(r+1,") - 5")},x2:p?e.rule_end:{expr:"".concat(t+1," * (width / ").concat(r+1,") + 5")}},encoding:{y:{field:_,type:"quantitative",aggregate:"max",axis:null}}},a={transform:m?[{filter:e.groupFilter}]:[{filter:e.filter}],name:"bottom_rule_".concat(e.groupId),mark:{type:"rule",x:p?e.rule_start:{expr:"".concat(t+1," * (width / ").concat(r+1,") - 5")},x2:p?e.rule_end:{expr:"".concat(t+1," * (width / ").concat(r+1,") + 5")}},encoding:{y:{field:_,type:"quantitative",aggregate:"min",axis:null}}};x.push(n,a)})),{$schema:r.SCHEME,width:u,height:d,meta:{all_groups:c},data:{name:"source",values:g},layer:[{name:"main",mark:e.mark,encoding:i(i({},e.encoding),{},{x:i(i({},e.encoding.x),{},{field:r.X_FIELD+"_pos"}),color:e.encoding.color})}].concat(x),resolve:{axis:{y:"independent"}}}},j=function(e,t){var n,a=[],o=t.spec||t,c=o.width,s=o.height,u=e.encoding.y.scale.domain,d=e.meta.hasFacet,m=e.meta,p=[],h=[r.X_FIELD];d&&(m.columnFacet&&h.push(m.columnFacet.field),m.rowFacet&&h.push(m.rowFacet.field)),(n=d3).rollups.apply(n,[e.data.values.slice(),function(e){var t=e[0][r.X_FIELD],n=e.slice().sort((function(e,t){return d3[d?"descending":"ascending"](e[r.Y_FIELD],t[r.Y_FIELD])})).map((function(e,t){return i(i({},e),{},{rank:t+1})})),o=d3.mean(n,(function(e){return d?e.oldY:e[r.Y_FIELD]})),c=d?e[0].scaleY(o):o,s=d3.mean(n,(function(e){return e.rank})),u=1.4*d3.max(n,(function(e){return e.rank})),h=d?25:1;n=n.map((function(e){var t,n=(e.rank-s)/u,a=(e.rank-.5-s)/u,d=(e.rank+.5-s)/u;return i(i({},e),{},(l(t={},r.X_FIELD+"_pos",e[r.X_FIELD]+n*h),l(t,r.X_FIELD+"_pos_start",e[r.X_FIELD]+a*h),l(t,r.X_FIELD+"_pos_end",e[r.X_FIELD]+d*h),l(t,"y_mean",o),l(t,"y_mean_pos",c),t))}));var g="datum['".concat(r.X_FIELD,"'] === ").concat(t),y=t;return d&&(g+=" && ",y+="_",m.columnFacet&&(g+="datum['".concat(m.columnFacet.field,"'] === '").concat(e[0][m.columnFacet.field],"'"),y+=e[0][m.columnFacet.field]),m.columnFacet&&m.rowFacet&&(g+=" && ",y+="_"),m.rowFacet&&(g+="datum['".concat(m.rowFacet.field,"'] === '").concat(e[0][m.rowFacet.field],"'"),y+=e[0][m.rowFacet.field])),a.push({filter:g,groupValue:t,groupKey:r.X_FIELD,groupId:y,mean:o,mean_pos:c,rule_start:d3.min(n,(function(e){return e[r.X_FIELD+"_pos_start"]})),rule_end:d3.max(n,(function(e){return e[r.X_FIELD+"_pos_end"]}))}),p.push.apply(p,f(n)),n}].concat(f(h.map((function(e){return function(t){return t[e]}})))));var g=[];return a.forEach((function(e,t){var n=a.length,o={transform:[{filter:e.filter}],name:"rule_".concat(e.groupId),mark:{type:"rule",x:d?e.rule_start:{expr:"".concat(t+1," * (width / ").concat(n+1,") - (width / ").concat(n+1,") * 0.35")},x2:d?e.rule_end:{expr:"".concat(t+1," * (width / ").concat(n+1,") + (width / ").concat(n+1,") * 0.35")}},encoding:{y:{field:d?"y_mean_pos":r.Y_FIELD,type:"quantitative",aggregate:"mean",axis:null,scale:{domain:u}}}};g.push(o)})),{$schema:r.SCHEME,width:c,height:s,meta:{all_groups:a},data:{name:"source",values:p},layer:[{name:"main",mark:e.mark,encoding:i(i({},e.encoding),{},{x:i(i({},e.encoding.x),{},{field:r.X_FIELD+"_pos"})})}].concat(g),resolve:{axis:{y:"independent"}}}},L=function(e,t){var n,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"min",o=t.spec||t,c=o.width,s=o.height,u="min"===a?d3.min:d3.max,l=e.encoding.y.scale.domain,d=[r.X_FIELD],m=e.meta.hasFacet,p=e.meta,h=[];m&&(p.columnFacet&&d.push(p.columnFacet.field),p.rowFacet&&d.push(p.rowFacet.field));var g=[];(n=d3).rollup.apply(n,[e.data.values.slice(),function(e){var t=e[0][r.X_FIELD],n="datum['".concat(r.X_FIELD,"'] === ").concat(t),a=t;m&&(n+=" && ",a+="_",p.columnFacet&&(n+="datum['".concat(p.columnFacet.field,"'] === '").concat(e[0][p.columnFacet.field],"'"),a+=e[0][p.columnFacet.field]),p.columnFacet&&p.rowFacet&&(n+=" && ",a+="_"),p.rowFacet&&(n+="datum['".concat(p.rowFacet.field,"'] === '").concat(e[0][p.rowFacet.field],"'"),a+=e[0][p.rowFacet.field]));var o=u(e,(function(e){return m?e.oldY:e[r.Y_FIELD]})),c=m?e[0].scaleY(o):o;g.push({filter:n,groupValue:t,groupKey:r.X_FIELD,aggr:o,aggr_pos:c,groupId:a,rule_start:d3.min(e,(function(e){return e[r.X_FIELD]-2})),rule_end:d3.max(e,(function(e){return e[r.X_FIELD]+2}))});var s=e.find((function(e){return(m?e.oldY:e[r.Y_FIELD])===o}));h.push.apply(h,f(e.map((function(e){var t=s&&s.gemini_id===e.gemini_id;return i(i({},e),{},{isAggr:t,aggr_pos:c})}))))}].concat(f(d.map((function(e){return function(t){return t[e]}})))));var y=g.map((function(e,t){var n=g.length;return{transform:[{filter:e.filter}],name:"rule_".concat(e.groupId),mark:{type:"rule",x:m?e.rule_start:{expr:"".concat(t+1," * (width / ").concat(n+1,") - 5")},x2:m?e.rule_end:{expr:"".concat(t+1," * (width / ").concat(n+1,") + 5")}},encoding:{y:{field:m?"aggr_pos":r.Y_FIELD,type:"quantitative",aggregate:a,axis:null,scale:{domain:l}}}}}));return{$schema:r.SCHEME,width:c,height:s,meta:{all_groups:g},data:{name:"source",values:h},layer:[{name:"main",mark:e.mark,encoding:i({},e.encoding)}].concat(f(y)),resolve:{axis:{y:"independent"}}}},I={count:(b=u(regeneratorRuntime.mark((function e(t,r){var n,a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_(t,10,!0);case 2:return delete(n=e.sent).encoding.y.axis,a=E(t,r,!1),o=E(t,r,!0),e.abrupt("return",[n,a,o,r]);case 7:case"end":return e.stop()}}),e)}))),function(e,t){return b.apply(this,arguments)}),min:function(e,t){var r=L(e,t,"min"),n=i(i({},r),{},{transform:[{filter:"datum.isAggr === true"}],layer:[i(i({},r.layer[0]),{},{encoding:i(i({},r.layer[0].encoding),{},{y:i(i({},r.layer[0].encoding.y),{},{aggregate:"min"})})})].concat(f(r.layer.slice(1)))});return[e,r,n,t]},max:function(e,t,r){var n=L(e,t,"max"),a=i(i({},n),{},{transform:[{filter:"datum.isAggr === true"}],layer:[i(i({},n.layer[0]),{},{encoding:i(i({},n.layer[0].encoding),{},{y:i(i({},n.layer[0].encoding.y),{},{aggregate:"max"})})})].concat(f(n.layer.slice(1)))});return[e,n,a,t]},mean:function(e,t){var n=j(e,t),a=2,o=i(i({},n),{},{layer:[{name:"main",mark:{type:"tick",orient:"horizontal",width:a},encoding:{y:i({},e.encoding.y),x:i(i({},e.encoding.x),{},{field:r.X_FIELD+"_pos_start"}),x2:{field:r.X_FIELD+"_pos_end"},color:e.encoding.color}}].concat(f(n.layer.slice(1)))}),c=i(i({},o),{},{layer:[i(i({},o.layer[0]),{},{mark:{type:"bar",width:a},encoding:i(i({},o.layer[0].encoding),{},{y2:{field:"y_mean_pos"}})})].concat(f(o.layer.slice(1)))}),s=i(i({},o),{},{layer:[i(i({},o.layer[0]),{},{mark:{type:"bar",width:a},encoding:i(i({},o.layer[0].encoding),{},{y:i(i({},o.layer[0].encoding.y),{},{field:"y_mean_pos"}),y2:{field:"y_mean_pos"}})})].concat(f(o.layer.slice(1)))});return[e,i(i({},e),{},{data:{values:n.data.values},encoding:i(i({},e.encoding),{},{x:i(i({},e.encoding.x),{},{field:r.X_FIELD+"_pos"})})}),n,o,c,s,t]},median:function(e,t,r,n){var a=null==n?.5:n;return[e,F(e,t,0,a),F(e,t,null,a),t]}};function k(e){var t,n=e.meta.description,a=e.meta.splitField;return{$scheme:r.SCHEME,width:300,height:300,meta:{description:n,axes:!1},data:{values:[(t={},l(t,r.X_FIELD,0),l(t,r.Y_FIELD,0),t)]},mark:{type:"point",filled:!0,strokeWidth:1,color:"transparent"},encoding:{x:{field:r.X_FIELD,type:"quantitative",scale:{domain:[-5,5]},axis:{grid:!1,ticks:!1,title:a,domain:!1,values:[]}},y:{field:r.Y_FIELD,type:"quantitative",scale:{domain:[-5,5]},axis:{grid:!1,ticks:!1,title:null,domain:!1,values:[]}}}}}function D(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:!0,y:!0},a=arguments.length>3?arguments[3]:void 0,o=a.spec.encoding,c=a.spec.mark,s=a.facet;if(o.x){var u=s&&s.column?s.column.title:null;o.x={field:r.X_FIELD,type:"quantitative",scale:{},axis:n.x?{labelExpr:"",values:[],title:u,grid:!1,orient:"top",ticks:!1,domain:!1,labelPadding:10}:null}}if(o.y){var l=s&&s.row?s.row.title:null;o.y={field:"errorbar"===a.spec.mark?o.y.field:r.Y_FIELD,type:"quantitative",scale:{},axis:n.y?{labelExpr:"",values:[],title:l,grid:!1,labelAngle:90,domain:!1,ticks:!1,labelPadding:10,orient:"right"}:null}}var d={};return a.transform&&(d.transform=a.transform),i({$schema:r.SCHEME,data:{values:[]},width:e,height:t,mark:c,encoding:o},d)}function S(e){var t,n,o=e.view,c=e.spec,s=e.width,u=void 0===s?600:s,d=e.height,f=void 0===d?600:d,m=c.facet.row?c.facet.row.field:null,p=c.facet.column?c.facet.column.field:null,h=D(u,f,{x:p,y:m},c),g=[f,0],y=[0,u],v=[],x=new Map,_=new Map,w=o.scale("x"),b=o.scale("y"),E=o.data("source");if(m&&(t=o.data("row_header"))){var F=[],j={};t.forEach((function(e,t){var r=e.bounds,n=e.datum[m],a=r.y1,o=r.y2;_.set(n,a);var i=Math.round(a+(o-a)/2);F.push(i),j[i]=n})),g[1]=d3.min(t,(function(e){return e.bounds.y1})),g[0]=d3.max(t,(function(e){return e.bounds.y2})),h.encoding.y.axis.values=F,h.encoding.y.axis.labelExpr="".concat(JSON.stringify(j),"[datum.label]")}if(p&&(n=o.data("column_header"))){var L=[],I={};n.forEach((function(e,t){var r=e.bounds,n=e.datum[p];x.set(n,r.x1);var a=Math.round(r.x1+(r.x2-r.x1)/2);L.push(a),I[a]=n})),y[0]=d3.min(n,(function(e){return e.bounds.x1})),y[1]=d3.max(n,(function(e){return e.bounds.x2})),h.encoding.x.axis.values=L,h.encoding.x.axis.labelExpr="".concat(JSON.stringify(I),"[datum.label]")}return E.forEach((function(e){var t,n=e[p],o=e[m],s=x.get(n)||0,u=_.get(o)||0,d=c.meta.parse===a.jitter?"x":r.X_FIELD,f=c.meta.parse===a.jitter?"y":r.Y_FIELD,h=s+w(e[d]);v.push(i(i({},e),{},(l(t={},r.X_FIELD,h),l(t,r.Y_FIELD,u+b(e[f])),l(t,r.X_FIELD+"_num",e.scaledX?s+w(e.scaledX):h),l(t,"scaleX",(function(e){return u+w(e)})),l(t,"scaleY",(function(e){return u+b(e)})),t)))})),h.encoding.x.scale.domain=y,h.encoding.y.scale.domain=g,h.data.values=v,h.width=y[1]-y[0],h.height=g[0]-g[1],h}function O(e){var t=document.createElement("div");return e.data.name="source",vegaEmbed(t,e,{renderer:"svg"}).then((function(t){var r=S(i(i({},t),{},{width:e.spec.width,height:e.spec.height}));e.config&&(r.config=e.config),e.meta&&(r.meta=e.meta);var n=d(t.view._origin,2),a=n[0],o=n[1];return e.facet&&e.facet.row&&!e.facet.column||(o=0),r.meta?(r.meta.transformX=a,r.meta.transformY=o):r.meta={transformX:a,transformY:o},r}))}e.App=function(e,t){var n,o,c,s,d,f,m,p=t.specs,y=t.autoPlay,x=void 0!==y&&y,b=t.frameDur,E=t.frameDel,F=0,j=!1,L=!1,D=b||2e3,S=E||1e3,X={timeline:{concat:[{sync:[{component:{mark:"marks"},change:{data:{keys:["gemini_id"],update:!0,enter:!0,exit:!1},encode:{update:!0,enter:!0,exit:!0}},timing:{duration:{ratio:1}}}]}]},totalDuration:D},q=function(){c=[],s=[],o=[],n=[],d=[],f=[],F=0,j=!1,m&&(clearTimeout(m),m=null)};function M(){return(M=u(regeneratorRuntime.mark((function t(){var r,a;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!L){t.next=2;break}return t.abrupt("return");case 2:return L=!0,r=h(e),a=r.slider,q(),p&&(c=JSON.parse(JSON.stringify(p))),c.forEach((function(e){o.push(JSON.parse(JSON.stringify(e))),n.push(JSON.parse(JSON.stringify(e))),e.meta&&f.push(e.meta)})),d3.select(a).property("max",c.length-1),t.next=10,C();case 10:return G(),t.next=13,H();case 13:A(0),x&&setTimeout(Y,100),L=!1;case 16:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Y(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};j=!0,F=0;var t=function t(){if(P(F,e).then((function(){j&&(F++,d[F]?t():(j=!1,W("enable")))})),"undefined"!=typeof HTMLWidgets&&HTMLWidgets.shinyMode){var r=F-1;Shiny.onInputChange("slider_state",r)}};W("disable"),t()}function A(t,r){var n=c[t];if(n){n.custom&&(n=gemini.vl2vg4gemini(n.sequence[n.sequence.length-1]));var a=f[t],o=h(e),i=o.axisSelector,s=o.visSelector,u=o.descr,l=o.slider,d=o.otherLayers,m=o.controls;o.exportWrap,d3.select(l).property("value",t),d3.select(u).html(a.description||"frame "+t),d3.select(i).style("opacity",a.axes?1:0).html(""),d3.select(s).classed("with-axes",a.axes),d3.select(d).classed("with-axes",a.axes),a.axes&&N(t);var p=a.transformX||0,g=a.transformY||0;d3.select(s).style("left",p+"px").style("top",g+"px");var y=n.width+p+10;return d3.select(m).style("width",y+"px"),d3.select(u).style("width",y+"px"),function(t,r){var n=h(e),a=n.visSelector,o=n.otherLayers,i=document.querySelector(o);return i.innerHTML="",Array.isArray(t)?new Promise((function(e){t.forEach((function(n,o){var c,s=n;if(n.meta.animated)c=a,r&&(s=r);else{var u=document.createElement("div");u.classList.add("vega-hidden-layer"),i.appendChild(u),c=u}vegaEmbed(c,s,{renderer:"svg"}).then((function(){o===t.length-1&&e(),setTimeout((function(){R()}),100)}))}))})):vegaEmbed(a,r||t,{renderer:"svg"})}(n,r&&r.custom?null:r)}}function R(){var t=h(e),r=t.axisSelector,n=t.otherLayers,a=d3.select(r).selectAll(".mark-group.cell>g").nodes(),o=d3.select(n).selectAll(".mark-group.cell>g").nodes();if(a.length===o.length)for(var i=0;i<a.length;i++){var c=a[i].getAttribute("transform");o[i].setAttribute("transform",c)}}function N(t){var n=o[t];n.spec&&n.spec.layer&&(n=g(n)[1]);var a=n.facet&&n.facet.column,i=h(e),c=i.axisSelector,s=i.controls,u=i.descr,l=i.otherLayers,d=n.spec?n.spec.encoding:n.encoding;if(!d.y.scale){var f=d3.extent(n.data.values,(function(e){return e[r.Y_FIELD]}));d.y.scale={domain:f}}return d.color&&(d.color.legend=null),d.fill&&(d.fill.legend=null),d.x&&d.x.axis&&(d.x.axis.labelAngle=-90,d.x.axis.titleOpacity=0),vegaEmbed(c,n,{renderer:"svg"}).then((function(){if(a&&a.title){var e=function(){var e=d3.select(this).attr("transform").split("(")[1].split(",")[0];return"translate(".concat(e,", 40)")};d3.select(c+" svg > g").attr("transform",e),d3.select(l+" svg > g").attr("transform",e)}var t=d3.select(c).node().getBoundingClientRect().width;d3.select(s).style("width",t+"px"),d3.select(u).style("width",t+"px")}))}function P(e,t){return T.apply(this,arguments)}function T(){return T=u(regeneratorRuntime.mark((function t(r,n){var a,o,i,s,u,l,f,p,g,y,v,x,_,w,b,E;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(d[r]){t.next=2;break}return t.abrupt("return");case 2:if(console.log("animating frame",r),a=h(e),o=a.axisSelector,i=a.visSelector,s=a.otherLayers,u=a.descr,l=a.slider,f=a.controls,p=d[r],g=p.source,y=p.target,v=p.gemSpec,x=p.currMeta,_=null,!g.custom){t.next=13;break}return w=gemini.vl2vg4gemini(g.sequence[g.sequence.length-1]),t.next=10,gemini.animate(w,y,v);case 10:_=t.sent,t.next=22;break;case 13:if(!y.custom){t.next=19;break}return t.next=16,gemini.animateSequence(y.sequence,v);case 16:_=t.sent,t.next=22;break;case 19:return t.next=21,gemini.animate(g,y,v);case 21:_=t.sent;case 22:return b=x.axes,E=y.width,m&&clearTimeout(m),0===r&&n&&n(0),t.abrupt("return",new Promise((function(e){A(r,g).then((function(){m=setTimeout((function(){d3.select(u).html(x.description),_.play(i).then((function(){d3.select(l).property("value",r+1),n&&n(r+1),e()}));var t=x.transformX||0,a=x.transformY||0;d3.select(i).transition().duration(750).style("left",t+"px").style("top",a+"px"),b?(N(r+1),d3.select(o).transition().duration(1e3).style("opacity",1),d3.select(i).classed("with-axes",!0),d3.select(s).classed("with-axes",!0)):(d3.select(o).transition().duration(1e3).style("opacity",0),d3.select(i).classed("with-axes",!1),d3.select(s).classed("with-axes",!1),d3.select(f).style("width",E+t+10+"px"),d3.select(u).style("width",E+t+10+"px"));var d=c[r+1];if(d&&Array.isArray(d)){var m=d.filter((function(e){return!e.meta.animated}));d3.select(s).html("").style("opacity",0).transition().duration(D/2).style("opacity",1),m.forEach((function(e){var t=document.createElement("div");t.classList.add("vega-hidden-layer"),vegaEmbed(t,e,{renderer:"svg"}).then((function(){R()})),document.querySelector(s).appendChild(t)}))}}),y.custom?0:S)}))})));case 27:case"end":return t.stop()}}),t)}))),T.apply(this,arguments)}function C(){return J.apply(this,arguments)}function J(){return(J=u(regeneratorRuntime.mark((function e(){var t,s,u,d,m,p,h,y,x,b,E,F,j,L,D,S,X,q,M,Y,A,R,N;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=v(c),s=0;case 2:if(!(s<c.length)){e.next=81;break}if(u=c[s],!Array.isArray(u)){e.next=6;break}return e.abrupt("continue",78);case 6:if(!(u.transform&&u.transform[0].filter&&u.transform[0].filter.oneOf&&0===u.transform[0].filter.oneOf.length)){e.next=13;break}return d=k(u),f[s]=d.meta,o[s]=d,u=d,c[s]=d,e.abrupt("continue",78);case 13:if(m=u.meta,p=m.parse,!m.custom_animation){e.next=36;break}if(h=m.custom_animation,y=null,Array.isArray(m.custom_animation)&&"quantile"===m.custom_animation[0]&&(y=m.custom_animation[1],h="median"),x=i(i({},o[s-1]),{},{data:n[s-1].data}),b=u,n[s-1].facet&&(x=i(i({},c[s-1]),{},{meta:i(i({},c[s-1].meta),{},{hasFacet:!0,columnFacet:n[s-1].facet.column,rowFacet:n[s-1].facet.row}),data:{values:c[s-1].data.values.map((function(e){return i(i({},e),{},l({},r.X_FIELD,e[r.X_FIELD+"_num"]))}))}})),!c[s].facet){e.next=28;break}return e.next=25,O(c[s]);case 25:E=e.sent,c[s]=E,b=E;case 28:if(!(F=I[h])){e.next=34;break}return e.next=32,F(x,b,c[s-1],y);case 32:j=e.sent,c[s]={custom:m.custom_animation,sequence:j};case 34:e.next=70;break;case 36:if(p!==a.grid){e.next=46;break}return e.next=39,_(u,t);case 39:L=e.sent,D=L.spec?L.spec.encoding:L.encoding,o[s].data.values=L.data.values,o[s].meta.axes&&o[s].meta.splitField&&((S=o[s].spec?o[s].spec.encoding:o[s].encoding).x.axis=D.x.axis,S.y.scale={domain:D.y.scale.domain},S.x.scale={domain:D.x.scale.domain}),c[s]=L,e.next=70;break;case 46:if(p!==a.jitter){e.next=52;break}return e.next=49,w(u);case 49:c[s]=e.sent,e.next=70;break;case 52:if(!(u.layer||u.spec&&u.spec.layer)){e.next=70;break}X=g(u),c[s]=[],q=0;case 56:if(!(q<X.length)){e.next=70;break}if(!((M=X[q]).facet&&M.spec&&M.meta.animated)){e.next=66;break}return e.next=61,O(M);case 61:Y=e.sent,c[s].push(Y),f[s]=Y.meta,e.next=67;break;case 66:c[s].push(M);case 67:q++,e.next=56;break;case 70:if(!c[s]){e.next=78;break}if(A=c[s].facet,R=c[s].spec,!A||!R){e.next=78;break}return e.next=76,O(c[s]);case 76:N=e.sent,c[s]=N;case 78:s++,e.next=2;break;case 81:console.log("parsed specs:",c);case 82:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function G(){s=c.map((function(e){if(e.custom)return e;var t=Array.isArray(e)?e.find((function(e){return e.meta.animated})):e;return gemini.vl2vg4gemini(t)}))}function H(){return B.apply(this,arguments)}function B(){return(B=u(regeneratorRuntime.mark((function e(){var t,r,n,a,o,c,u,l,m,p;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t={stageN:1,scales:{x:{domainDimension:"diff"},y:{domainDimension:"diff"}},marks:{marks:{change:{scale:["x","y"],data:{keys:["gemini_id"],update:!0,enter:!0,exit:!0},encode:{update:!0,enter:!0,exit:!0}}}},totalDuration:D},r=1;case 2:if(!(r<s.length)){e.next=33;break}if(n=s[r-1],a=s[r],o=f[r-1],c=f[r],e.prev=7,u=null,!a.custom){e.next=18;break}return e.next=12,gemini.recommendForSeq(a.sequence,i(i({},t),{},{stageN:a.sequence.length-1,totalDuration:2*D}));case 12:u=e.sent,(l=u[0].specs.map((function(e){return e.spec}))).forEach((function(e){if(e.timeline.concat.length){var t=e.timeline.concat[0].sync[0];t&&t.change&&t.change.data&&(t.change.data={keys:["gemini_id"],update:!0,enter:!0,exit:!0})}})),d.push({source:n,target:a,gemSpec:l,prevMeta:o,currMeta:c}),e.next=25;break;case 18:return e.next=20,gemini.recommend(n.custom?gemini.vl2vg4gemini(n.sequence[n.sequence.length-1]):n,a,t);case 20:u=e.sent,m=u[0]?u[0].spec:X,(p=m.timeline.concat[0].sync).some((function(e){return"view"===e.component}))||p.push({component:"view",change:{signal:["width","height"]},timing:{duration:{ratio:1}}}),d.push({source:n,target:a,gemSpec:m,prevMeta:o,currMeta:c});case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(7),console.error(e.t0);case 30:r++,e.next=2;break;case 33:case"end":return e.stop()}}),e,null,[[7,27]])})))).apply(this,arguments)}function W(t,r){var n=h(e),a=n.replayBtn,o=n.exportBtn,i=n.slider,c=[a,o];r&&r.slider&&c.push(i),c.forEach((function(e){var r=document.querySelector(e);"disable"==t?r.setAttribute("disabled","disabled"):r.removeAttribute("disabled")}))}function V(t){var r=h(e).exportBtn,n="fas fa-download";t&&(n="fas fa-spinner spin"),d3.select(r).select("i").attr("class",n)}return function(){M.apply(this,arguments)}(),{onSlide:function(){j=!1,W("enable");var t=h(e).slider;A(document.querySelector(t).value)},play:Y,exportPNG:function(){var t=h(e).exportWrap,r=[];Y((function(e){var n=e>=d.length;html2canvas(document.querySelector(t)).then((function(e){r.push(e.toDataURL()),n&&r.forEach((function(e,t){var r=document.createElement("a");r.href=e,r.download="frame-".concat(t+1,".png"),r.click()}))}))}))},exportGif:function(t){var r=h(e),n=r.exportWrap;r.exportBtn,t&&(V(!0),W("disable",{slider:!0}));var a,o=[],i=function(){a&&clearInterval(a),a=setInterval((function(){html2canvas(document.querySelector(n)).then((function(e){o.push(e.toDataURL())}))}),16.66666)},c=300,s=300;return new Promise((function(e){Y((function(r){var u=r>=d.length,l=document.querySelector(n).getBoundingClientRect();l.width>c&&(c=l.width),l.height>s&&(s=l.height),u?(a&&clearInterval(a),setTimeout((function(){gifshot.createGIF({images:o,gifWidth:c,gifHeight:s,frameDuration:2.5},(function(r){if(t&&(V(!1),W("enable",{slider:!0})),r.error)console.error("error creating gif",r.errorMsg);else{var n=r.image;t&&download(n,"animation.gif","image/gif"),e(n)}}))}),1e3)):(a&&clearInterval(a),setTimeout(i,S))}))}))},animateFrame:P,getFrames:function(){return d}}},e.CONF=r,e.CustomAnimations=I,e.IGNORE_FIELDS=n,e.META_PARSE_VALUES=a,e.generateGrid=x,e.getCountStep=E,e.getEmptySpec=k,e.getGridSpec=_,e.getHackedSpec=S,e.getJitterSpec=w,e.getMeanStep=j,e.getMedianStep=F,e.getMinMaxStep=L,e.getRows=v,e.getSelectors=h,e.getSpecTemplate=D,e.hackFacet=O,e.lookupByBucket=y,e.splitLayers=g}));
//# sourceMappingURL=datamations.min.js.map
